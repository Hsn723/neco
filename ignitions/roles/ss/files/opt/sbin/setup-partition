#!/bin/sh -u

PART_TYPE=f800
PART_NAME=ceph-osd

# Execute the following subcommands.
#  1. o : create a new empty GUID partition table (GPT)
#  2. n : add a new partition
#  3. c : change a partition's name
#  4. w : write table to disk and exit
GDISK_CMD=$(cat << EOS
o
y
n



$PART_TYPE
c
$PART_NAME
w
y
EOS
)

is_target_device() {
    DEV=$(basename $1)
    if [ $DEV = 'vda' ] || [ $DEV = 'vdb' ]; then
        # in the case of qemu's system disks, enter here
        echo 'false'
    elif [ -e /sys/block/$DEV/device/model ] &&
         grep -q DELLBOSS /sys/block/$DEV/device/model; then
        # in the case of BOSS, enter here
        echo 'false'
    else
        echo 'true'
    fi
}

for DM in $(ls /dev/dm-*); do
    DEV_PATH=$(cryptsetup status $DM | grep device | awk '{print $2}')
    if [ -n "$DEV_PATH" ]; then
        if [ $(is_target_device $DEV_PATH) = 'true' ]; then
            tmp=$(echo i | gdisk $DM 2> /dev/null | grep "Partition name:" | grep "'$PART_NAME'")
            if [ -z "$tmp" ]; then
                echo "create a partition on $DM (backed by $DEV_PATH)"
                echo "$GDISK_CMD" | gdisk $DM
            fi
            echo "update partition devmappings on $DM"
            kpartx -u $DM
        fi
    fi
done
